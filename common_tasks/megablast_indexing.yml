---
################################################################################
# Bio-DAMNED - Bio-Data Ansible MaNagED                                        #
#                                                                              #
# Authors: Bertrand NÃ©ron                                                      #
# Copyright Â© 2016  Institut Pasteur (Paris).                                  #
#                                                                              #
# Bio-DAMNED is distributed under the terms of the GNU General Public License  #
# (GPLv3). See the LICENSE file for details.                                   #
################################################################################



- name: Cleaning "{{ bank_name }}/{{ blast_plus_vers }}" megablast+ indexes links
  become: yes
  become_user: "{{ bank_user }}"
  file: path={{bank_root}}/index/blast+/{{ blast_plus_vers }}/{{ item | basename }}
        state=absent
  with_fileglob:
    - "{{ bank_root }}/{{ bank_name }}/blast+/{{ blast_plus_vers }}/{{ bank_name }}.idx"

- name: Cleaning "{{ bank_name }}/{{ blast_plus_vers }}" blast+ indexes
  become: yes
  become_user: "{{ bank_user }}"
  file: path={{ item }} state=absent
  with_fileglob:
    - "{{ bank_root }}/{{ bank_name }}/blast+/{{ blast_plus_vers }}/*"

- name: Creating megablast indexes for  "{{ bank_name }}/{{ blast_plus_vers }}"
  become: yes
  become_user: "{{ bank_user }}"
  shell: >
    source {{ module_init }} && \
    module purge && \
    module load blast+/{{ blast_plus_vers }} && \
    makembindex -iformat blastdb -in {{ bank_root }}/{{ bank_name }}/blast+/{{ blast_plus_vers }} -logfile /dev/null
    chdir={{ bank_root }}/{{ bank_name }}/blast+/{{ blast_plus_vers }}

- name: Creating links to megablast indexes
  become: yes
  become_user: "{{ bank_user }}"
  file: >
    src={{ bank_root }}/{{ bank_name }}/blast+/{{ blast_plus_vers }}/{{ bank_name }}.idx
    dest={{bank_root}}/index/blast+/{{ blast_plus_vers }}/{{ bank_name }}.idx
    state=link
